CREATE DATABASE QL_Benh_Vien8823
USE QL_Benh_Vien8823

CREATE TABLE NHANVIEN (
	MANV	NVARCHAR(10)	NOT NULL,
	HOTEN	NVARCHAR(50)	NOT NULL,
	NGAYSINH	DATETIME	NOT NULL,
	NGAYVAOLAM	DATETIME	NOT NULL,
	NGAYNGHILAM	DATETIME	NULL,
	QUEQUAN	NVARCHAR(50)	NOT NULL,
	DIENTHOAI	VARCHAR(10)	NOT NULL,
	EMAIL	NVARCHAR(50)	NOT NULL,
	CONSTRAINT PK_NHANVIEN
		PRIMARY KEY(MANV),
);
INSERT INTO NHANVIEN
	VALUES ('211298',N'Vũ Mạnh Thắng','1939-5-26','1964-3-6','2003-10-1',N'Phú Thọ','0987857432','@YAHOO.COM')
INSERT INTO NHANVIEN
	VALUES ('211223',N'Lại Thế Phong','1942-8-27','1965-3-2','2010-9-25',N'Thái Nguyên','054305917','PHONGLT27@GMAIL.COM')
INSERT INTO NHANVIEN
	VALUES ('211277',N'Trương Thị Hạnh','1949-9-23','1972-5-2','2018-6-23',N'Vĩnh Phúc','023540981','TRTHHANH49@YAHOO.COM')
INSERT INTO NHANVIEN
	VALUES ('211281',N'Phan Khánh Hà','1944-4-13','1968-2-29','2014-3-19',N'Bắc Ninh','0293021948','HAPK1403@YAHOO.COM')
INSERT INTO NHANVIEN
	VALUES ('211218',N'Võ Văn Trúc','1933-3-14','1960-5-19','2005-12-9',N'Hà Nội','0129473812','VVT45@GMAIL.COM')
INSERT INTO NHANVIEN
	VALUES ('211229',N'Mai Quốc Khánh','1954-9-1','1975-4-10','2020-6-5',N'Lào Cai','0948572384','MQK0109@YAHOO.COM')
INSERT INTO NHANVIEN
	VALUES ('211200',N'Vũ Huy Hoàng','1996-8-5','2018-7-4',NULL,N'Hà Nội','0874369127','VHHOANG90@GMAIL.COM')
INSERT INTO NHANVIEN
	VALUES ('211201',N'Phạm Việt Hùng','1972-3-12','1999-9-2',NULL,N'Thái Bình','0369666999','PVHUNG1981@GMAIL.COM')
INSERT INTO NHANVIEN
	VALUES ('211212 ',N'Trần Văn Hùng','1979-7-23','2002-8-13',NULL,N'Thái Bình','0355120230','TRANHUNG1979@GMAIL.COM')
INSERT INTO NHANVIEN
	VALUES ('211254',N'Vũ Quang Dũng','1975-4-19','1999-9-5',NULL,N'Bình Dương','0356249349','VQDUNG1975@GMAIL.COM')
INSERT INTO NHANVIEN
	VALUES ('211265',N'Trần Quang Anh','1969-4-28','1990-8-15',NULL,N'Quảng Ninh','0359444214','QUANGANH91@GMAIL.COM')
INSERT INTO NHANVIEN
	VALUES ('211243',N'Nguyễn Anh Tuấn','1971-4-1','1995-11-12',NULL,N'Nam Định','0469894544','NATUAN86@GMAIL.COM')
INSERT INTO NHANVIEN
	VALUES ('211514',N'Nguyễn Thị Thuỷ','1983-7-12','2004-8-20',NULL,N'Quảng Ninh','0786185541','NTTUY90@GMAIL.COM')
INSERT INTO NHANVIEN
	VALUES ('211562',N'Vũ Xuân Quang','1984-4-7','2006-8-19',NULL,N'Nam Định','0378413957','VXQUANG99@GMAIL.COM')
INSERT INTO NHANVIEN
	VALUES ('211241',N'Vũ Minh Đức','1970-2-15','1996-4-30',NULL,N'Hà Nội ','0345111550','DUCVU96@GMAIL.COM')
INSERT INTO NHANVIEN
	VALUES ('211249',N'Vũ Bảo Lâm','1980-12-1','2005-4-25',NULL,N'Hải Phòng','0786185234','VBLAM96@GMAIL.COM');

CREATE TABLE NGUOITHAN(
	MANV	NVARCHAR(10)	NOT NULL,
	HOTEN	NVARCHAR(50)	NOT NULL,
	SODT	INT	NOT NULL,
	CONSTRAINT PK_NGUOITHAN
		PRIMARY KEY(MANV),
	CONSTRAINT FK_NGUOITHAN_NHANVIEN
		FOREIGN KEY(MANV)	REFERENCES NHANVIEN(MANV),
);
INSERT INTO NGUOITHAN
	VALUES ('211200',N'Nguyễn Thế Anh','0548639961')
INSERT INTO NGUOITHAN
	VALUES ('211201',N'Trần Nam Anh','0266541297')
INSERT INTO NGUOITHAN
	VALUES ('211212',N'Vũ Văn Đạt','0254921462')
INSERT INTO NGUOITHAN
	VALUES ('211254',N'Trần Chí Trung','0536971254')
INSERT INTO NGUOITHAN
	VALUES ('211243',N'Phạm Văn Cường','0953614792')
INSERT INTO NGUOITHAN
	VALUES ('211249',N'Vũ Thị Ánh','0953614792');
	
CREATE TABLE KHOA
(	
	MAKHOA	NVARCHAR(10)	NOT NULL,
	TENKHOA		NVARCHAR(50)	NOT NULL,
	TRUONGKHOA	NVARCHAR(10)	NOT NULL,
	CONSTRAINT PK_KHOA
		PRIMARY KEY(MAKHOA),
	CONSTRAINT FK_KHOA_NHANVIEN
		FOREIGN KEY(TRUONGKHOA)	REFERENCES NHANVIEN(MANV),
);
INSERT INTO KHOA
	VALUES ('HHTM',N'Huyết học truyền máu','211201')
INSERT INTO KHOA
	VALUES ('PNB',N'Phòng nằm bệnh','211562')
INSERT INTO KHOA
	VALUES ('CMT',N'Hoá sinh','211243')
INSERT INTO KHOA
	VALUES ('ICU',N'Hồi sức-Cấp cứu-Chống độc','211212')
INSERT INTO KHOA
	VALUES ('CVS',N'Tim mạch','211265');

CREATE TABLE PHONG
(
	MAPHONG	NVARCHAR(10)	NOT NULL,
	TENPHONG	NVARCHAR(50)	NOT NULL,
	MAKHOA	NVARCHAR(10)	NOT NULL,
	TRUONGPHONG	NVARCHAR (10)	NOT NULL,
	CONSTRAINT PK_PHONG
		PRIMARY KEY(MAPHONG),
	CONSTRAINT FK_PHONG_NHANVIEN
		FOREIGN KEY(TRUONGPHONG)	REFERENCES NHANVIEN(MANV),
	CONSTRAINT FK_PHONG_KHOA
		FOREIGN KEY(MAKHOA)	REFERENCES KHOA(MAKHOA),
);
INSERT INTO PHONG
	VALUES ('ICU1',N'Hồi sức-Cấp cứu-Chống độc-1','ICU','211200')
INSERT INTO PHONG
	VALUES ('ICU2',N'Hồi sức-Cấp cứu-Chống độc-2','ICU','211249')
INSERT INTO PHONG
	VALUES ('CVS1',N'Tim mạch-1','CVS','211241')
INSERT INTO PHONG
	VALUES ('CVS2',N'Tim mạch-2','CVS','211514');

CREATE TABLE LAMVIEC
(
	MANV	NVARCHAR(10)	NOT NULL,
	MAPHONG	NVARCHAR(10)	NOT NULL,
	CONSTRAINT PK_LAMVIEC
		PRIMARY KEY(MANV, MAPHONG),
	CONSTRAINT FK_LAMVIEC_NHANVIEN
		FOREIGN KEY(MANV)	REFERENCES NHANVIEN(MANV),
	CONSTRAINT FK_LAMVIEC_PHONG
		FOREIGN KEY(MAPHONG)	REFERENCES PHONG(MAPHONG),
);
INSERT INTO LAMVIEC
	VALUES ('211200','ICU1')
INSERT INTO LAMVIEC
	VALUES ('211201','ICU2')
INSERT INTO LAMVIEC
	VALUES ('211212','ICU1')
INSERT INTO LAMVIEC
	VALUES ('211254','CVS2')
INSERT INTO LAMVIEC
	VALUES ('211265','CVS2')
INSERT INTO LAMVIEC
	VALUES ('211243','CVS1')
INSERT INTO LAMVIEC
	VALUES ('211514','CVS2')
INSERT INTO LAMVIEC
	VALUES ('211562','ICU2')
INSERT INTO LAMVIEC
	VALUES ('211241','CVS1')
INSERT INTO LAMVIEC
	VALUES ('211249','ICU2');

CREATE TABLE CHUCVU
(
	MANV	NVARCHAR(10)	NOT NULL,

	TENCHUCVU	NVARCHAR(30)	NOT NULL,
	NGAYBD	DATETIME	NOT NULL,
	NGAYKT	DATETIME	 NULL,
	CONSTRAINT PK_CHUCVU
		PRIMARY KEY(MANV,TENCHUCVU),
	CONSTRAINT FK_CHUCVU_NHANVIEN
		FOREIGN KEY(MANV)	REFERENCES NHANVIEN(MANV),
);
INSERT INTO CHUCVU
	VALUES ('211200',N'Trưởng phòng ','2022-6-28',NULL)
INSERT INTO CHUCVU
	VALUES ('211201',N'Trưởng phòng','2012-6-12','2017-6-4')
INSERT INTO CHUCVU
	VALUES ('211201',N'Trưởng khoa ','2017-6-5',NULL)
INSERT INTO CHUCVU
	VALUES ('211212',N'Trưởng phòng','2007-6-12','2017-6-1')
INSERT INTO CHUCVU
	VALUES ('211212',N'Trưởng khoa','2017-6-2',NULL)
INSERT INTO CHUCVU
	VALUES ('211265',N'Trưởng phòng','2017-6-12','2022-6-22')
INSERT INTO CHUCVU
	VALUES ('211265',N'Trưởng khoa','2022-6-23',NULL)
INSERT INTO CHUCVU
	VALUES ('211562',N'Trưởng phòng','2017-6-5','2022-6-8')
INSERT INTO CHUCVU
	VALUES ('211562',N'Trưởng khoa','2022-6-9',NULL)
INSERT INTO CHUCVU
	VALUES ('211243',N'Trưởng phòng','2012-6-18','2017-6-23')
INSERT INTO CHUCVU
	VALUES ('211243',N'Trưởng khoa','2017-6-24',NULL)
INSERT INTO CHUCVU
	VALUES ('211249',N'Trưởng phòng','2017-6-17',NULL)
INSERT INTO CHUCVU
	VALUES ('211241',N'Trưởng phòng','2022-6-19',NULL)
INSERT INTO CHUCVU
	VALUES ('211514',N'Trưởng phòng','2022-6-25',NULL);

CREATE TABLE TRINHDO
(
	MANV	NVARCHAR(10)	NOT NULL,
	TRINHDO	NVARCHAR(20)	NOT NULL,
	NGAYDATDUOC	DATETIME	NOT NULL,
	CONSTRAINT	PK_TRINHDO
		PRIMARY KEY(MANV,TRINHDO),
	CONSTRAINT FK_TRINHDO_NHANVIEN
		FOREIGN KEY(MANV)	REFERENCES NHANVIEN(MANV),
);
INSERT INTO TRINHDO
	VALUES ('211201',N'Tiến sĩ','2000-5-5')
INSERT INTO TRINHDO
	VALUES ('211212',N'Tiến sĩ','2005-8-8')
INSERT INTO TRINHDO
	VALUES ('211254',N'Phó giáo sư','2003-6-3')
INSERT INTO TRINHDO
	VALUES ('211265',N'Giáo sư','1998-7-2')
INSERT INTO TRINHDO
	VALUES ('211243',N'Giáo sư','2007-8-23')
INSERT INTO TRINHDO
	VALUES ('211562',N'Giáo sư','2013-9-15')
INSERT INTO TRINHDO
	VALUES ('211241',N'Phó giáo sư','2009-10-12');


CREATE TABLE MAYMOC
(
	MAMAY	NVARCHAR(30)	NOT NULL,
	TENMAY	NVARCHAR(30)	NOT NULL,
	MAKHOA	NVARCHAR(10)	NOT NULL,
	CONSTRAINT PK_MAYMOC
		PRIMARY KEY(MAMAY),
	CONSTRAINT FK_MAYMOC_KHOA
		FOREIGN KEY(MAKHOA)	REFERENCES KHOA(MAKHOA),
);
INSERT INTO MAYMOC
	VALUES ('ICUM-1',N'Máy trợ tim','ICU')
INSERT INTO MAYMOC
	VALUES ('ICUM-2',N'Máy bơm insulin','ICU')
INSERT INTO MAYMOC
	VALUES ('CVSM-1',N'Hệ thống máy thở','CVS')
INSERT INTO MAYMOC
	VALUES ('CVSM-2',N'Máy thở xâm lấn','CVS')
INSERT INTO MAYMOC
	VALUES ('PNBM-1',N'Nệm áp lực','PNB');

--1, tìm thông tin của nhân viên có quê quán Nam Định
	SELECT *
	FROM NHANVIEN
	WHERE QUEQUAN = N'Nam Định'

--2, tìm thông tin các nhân viên đã nghỉ hưu
	SELECT *
	FROM NHANVIEN
	WHERE NGAYNGHILAM IS NOT NULL;

--3, tìm thông tin của nhân viên ko có người thân
	SELECT nhanvien.*
	FROM NHANVIEN
	LEFT JOIN NGUOITHAN ON NHANVIEN.MANV = NGUOITHAN.MANV
	WHERE NGUOITHAN.MANV IS NULL;

--4, tìm thông tin máy thuôc khoa ICU
	SELECT *
	FROM MAYMOC
	WHERE MAKHOA ='ICU'; 

--5, Tìm các nhân viên có trên 5 năm kinh nghiệm
	SELECT MANV, HOTEN, YEAR(GETDATE())-YEAR(NGAYVAOLAM) AS NAMKN
	FROM NHANVIEN
	WHERE YEAR(GETDATE())-YEAR(NGAYVAOLAM) > 5;

--6, Cho biết tên nhân viên đến từ phòng 'CVS2'
	SELECT NHANVIEN.MANV, NHANVIEN.HOTEN, LAMVIEC.MAPHONG, NHANVIEN.NGAYSINH, NHANVIEN.NGAYVAOLAM, NHANVIEN.NGAYNGHILAM, NHANVIEN.QUEQUAN, NHANVIEN.DIENTHOAI, NHANVIEN.EMAIL
	INTO NV
	FROM (NHANVIEN INNER JOIN LAMVIEC ON NHANVIEN.MANV = LAMVIEC.MANV);
	SELECT MANV, HOTEN, MAPHONG
	FROM NV
	WHERE MAPHONG = 'CVS2';

--7, Đếm số nhân viên đến từ khoa 'ICU'
	SELECT MAPHONG, MAKHOA
	INTO G1
	FROM PHONG
	WHERE MAKHOA = 'ICU';
	SELECT COUNT(*) AS SO_NV_ICU
	FROM (NV INNER JOIN G1 ON NV.MAPHONG=G1.MAPHONG);

--8, liệt kê thông tin các nhân viên có trình độ tiến sĩ trc ngay 20/10/2012
	SELECT NV.MANV, NV.HOTEN, TRINHDO.TRINHDO, TRINHDO.NGAYDATDUOC
	FROM (NV INNER JOIN TRINHDO ON NV.MANV = TRINHDO.MANV)
	WHERE TRINHDO.TRINHDO = N'Tiến sĩ' AND TRINHDO.NGAYDATDUOC < '2012-10-20';

--9, lấy tên và địa chỉ email của các nhân viên có trình độ giáo sư
	SELECT MANV, TRINHDO
	INTO I1
	FROM TRINHDO
	WHERE TRINHDO=N'Giáo sư';
	SELECT NHANVIEN.HOTEN, NHANVIEN.EMAIL, I1.TRINHDO
	FROM (NHANVIEN INNER JOIN I1 ON NHANVIEN.MANV = I1.MANV);

--10, tính số lượng nhân viên theo từng trình độ
	SELECT TRINHDO, COUNT(*) AS SL
	FROM TRINHDO
	GROUP BY TRINHDO;

--11, Cho biết tên, chức vụ hiện tại của nhân viên
	SELECT MANV, TENCHUCVU, NGAYKT
	INTO J1
	FROM CHUCVU
	WHERE NGAYKT IS NULL;
	SELECT NHANVIEN.MANV, NHANVIEN.HOTEN, J1.TENCHUCVU
	FROM (NHANVIEN INNER JOIN J1 ON NHANVIEN.MANV = J1.MANV);

--12, Cho biết tên, tuổi của nhân viên có trình độ tiến sĩ
	SELECT MANV, TRINHDO
	INTO K1
	FROM TRINHDO
	WHERE TRINHDO = N'TIẾN SĨ';
	SELECT NHANVIEN.MANV, NHANVIEN.HOTEN, YEAR(GETDATE()) - YEAR(NHANVIEN.NGAYSINH) AS TUOI, K1.TRINHDO
	FROM (NHANVIEN INNER JOIN K1 ON NHANVIEN.MANV = K1.MANV);

--13, Cho biết tên các trưởng khoa đang đương chức
	SELECT MANV, TENCHUCVU, NGAYKT
	INTO L1
	FROM CHUCVU
	WHERE TENCHUCVU=N'Trưởng khoa' AND NGAYKT IS NULL;
	SELECT NHANVIEN.MANV, NHANVIEN.HOTEN
	FROM (NHANVIEN INNER JOIN L1 ON NHANVIEN.MANV = L1.MANV);

--14, Cho biết tên, ngày sinh trưởng phòng trẻ tuổi nhất từng đương chức
	SELECT MANV,HOTEN, NGAYSINH
	INTO M1
	FROM NHANVIEN;
	SELECT MANV, NGAYBD
	INTO M2
	FROM CHUCVU
	WHERE TENCHUCVU=N'Trưởng phòng' AND NGAYKT IS NULL;
	SELECT M1.MANV, M1.HOTEN, M1.NGAYSINH, M2.NGAYBD, YEAR(NGAYBD)-YEAR(NGAYSINH) AS TUOILUCDATCHUC
	INTO M3
	FROM (M1 INNER JOIN M2 ON M1.MANV = M2.MANV);
	SELECT MANV, HOTEN, NGAYSINH, TUOILUCDATCHUC
	FROM M3
	WHERE TUOILUCDATCHUC = (
		SELECT MIN(TUOILUCDATCHUC)
		FROM M3
	);

--15, Cho biết tên, quá trình công tác của các trưởng khoa đang đương chức
	SELECT MANV
	INTO N1
	FROM CHUCVU
	WHERE TENCHUCVU=N'Trưởng khoa' AND NGAYKT IS NULL;
	SELECT N1.MANV AS MNV, CHUCVU.TENCHUCVU, CHUCVU.NGAYBD, CHUCVU.NGAYKT
	INTO N2
	FROM (N1 INNER JOIN CHUCVU ON N1.MANV=CHUCVU.MANV);
	SELECT NHANVIEN.MANV, NHANVIEN.HOTEN, N2.TENCHUCVU, N2.NGAYBD, N2.NGAYKT
	FROM(NHANVIEN INNER JOIN N2 ON NHANVIEN.MANV = N2.MNV)
	ORDER BY MANV, NGAYBD;

